## Social app schema

### Схема организации бэкенда для указанного приложения

#### Структура бэкенда:

1. **Сервис контента** (основной сервис приложения):
    1. Aдминка для управления основными сущностями домена проекта (пользователи, статусы пользователей, картинки, теги,
       страны)
    2. Бизнес-логика:
        1. Выдача фронту упорядоченного списка id картинок по параметрам

        2. Выдача фронту данных по картинкам с измененной информацией

        3. Выдача фронту данных о лайках и комментариях по списку id картинок - в данном случае сервис контента
           выступает
           как фасад для фронта для получения сразу и лайков.
           Сервис контента получает в соседних сервисах кол-во лайков и комментариев по списку id картинок и возвращает
           на фронт
           общую статистику в разрезе id картинки (дл снижения нагрузки на сервис контента есть рекомендация вынести
           фасад в отдельный сервис)


2. **Сервис лайков картинок**:
    1. Отдача сервису контента статистики по лайкам картинок

3. **Сервис комментариев картинок**:
    1. Отдача сервису контента статистики по комментариям картинок

#### Зависимости бэкенда:

1. Реляционная СУБД PostgreSQL - персистентное хранилище сервиса контента
   (таблицы `image`, `status`, `tag`, `country`, `image_status`, `image_tag`, `image_country`)
2. MongoDB/Redis - персистентное хранилище сервиса лайков (коллекция с кол-вом лайков в разрезе id картинки)
3. MongoDB/Redis - персистентное хранилище сервиса комментариев (аналогично лайкам)
4. Redis - кэш для ускорения отдачи ответа сервиса контента
5. Nginx - отдача статических файлов картинок

#### Кэш (предлагается следующий вариант кэширования):

1. Все возможные вариации запроса на получение ленты картинок и соответствующий каждому запросу ответ 
всегда закэшированы в Redis. 
Ключ - состав запроса (статус, теги, страны), значение - список id картинок и время изменения каждой картинки.
Создание/удаление/изменение в основной БД карточки триггерит обновление ключей в Redis по параметрам измененной картинки (статус, теги, страны).
При получении запроса сервис идет только в Redis и забирает готовый ответ по ключу (формируется из состава запроса).
При старте сервиса требуется первичное наполнение кэша.

Кэширование ответов по лайкам/комментариям не предполагается.
Кэширование ответа по списку изменений в текущем виде не предполагается, 
возможной является реализация схемы с доп кэшем в Redis для списка обновлений.  

2. Дополнительно:
Есть смысл собрать статистику по наиболее частым запросам в разрезе стран/регионов 
и разместить redis в соответствующих странах/регионах

**Расчет кэша:**

- Общее кол-во вариантов таргетирования: `108460 (2 * 290 * 187`)
- Средний размер ключа и значения в кэше (читай состав запроса и ответа на него): `~10-12 Kb`
- Общее кол-во вариантов сортировки: `3` (по времени изменения, по кол-ву лайков, по кол-ву комментариев)
- Расчетный размер кэша: `108460 * 3 * 11 = ~3495 Mb`

#### Рекомендации по железу:

- SSD-диск для хранилища картинок
- M2-диск для хранилищ сервисов
- Предполагается 2 отдельных сервера (сервис контента размещен на отдельном  сервере)

#### Состав ответов бэкенда:

1. Получение упорядоченного списка id картинок c датой и временем
   изменения (```GET /images?status=premium&tag=cinema&geo=US&page=1&limit=20```):

```json
[
  {
    "img_id": 1000,
    "img_updated_at": "2023-01-19T10:55:05.555Z"
  },
  {
    "img_id": 2000,
    "img_updated_at": "2023-01-19T10:56:05.555Z"
  }
]
```

2. Получение n карточек, у которых есть новая
   информация (``` GET /images?updated_since=2023-01-19T10:56:05.555Z&page=1&limit=5```)

```json
[
  {
    "img_id": 1001,
    "img_title": "Home alone poster",
    "img_desc": "New Year holiday family comedy",
    "img_url": "/images/1001.jpeg",
    "img_updated_at": "2023-01-19T10:57:05.555Z"
  },
  {
    "img_id": 2001,
    "img_title": "Hobbit An unexpected journey poster",
    "img_desc": "Great film based on a J. Tolkien book",
    "img_url": "/images/2001.jpeg",
    "img_updated_at": "2023-01-19T10:58:05.555Z"
  }
]
```

3. На запрос получения лайков и комментариев по n картинкам (``` GET /images/stats?img_id=1000&img_id=2000```)

```json
[
  {
    "img_id": 1000,
    "img_like_count": 10,
    "img_comment_count": 5
  },
  {
    "img_id": 2000,
    "img_like_count": 20,
    "img_comment_count": 15
  }
]
```




